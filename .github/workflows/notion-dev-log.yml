name: Notion Dev Log

on:
  push:
    branches: [master, main, develop]

jobs:
  log-to-notion:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Collect commit info
        id: info
        run: |
          MESSAGE=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(git log -1 --pretty=format:'%aI')
          HASH=$(git log -1 --pretty=format:'%H')
          SHORT_HASH=$(git log -1 --pretty=format:'%h')
          BRANCH=${GITHUB_REF#refs/heads/}
          FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | head -30 | tr '\n' ', ' | sed 's/,$//')

          echo "message=$MESSAGE" >> "$GITHUB_OUTPUT"
          echo "author=$AUTHOR" >> "$GITHUB_OUTPUT"
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
          echo "short_hash=$SHORT_HASH" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Create Notion page
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          curl -s -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "$(cat <<EOF
          {
            "parent": { "database_id": "$NOTION_DATABASE_ID" },
            "properties": {
              "Name": {
                "title": [{ "text": { "content": "${{ steps.info.outputs.message }}" } }]
              },
              "Branch": {
                "select": { "name": "${{ steps.info.outputs.branch }}" }
              },
              "Author": {
                "rich_text": [{ "text": { "content": "${{ steps.info.outputs.author }}" } }]
              },
              "Date": {
                "date": { "start": "${{ steps.info.outputs.date }}" }
              },
              "Commit": {
                "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.info.outputs.hash }}"
              },
              "Files": {
                "rich_text": [{ "text": { "content": "${{ steps.info.outputs.files }}" } }]
              }
            }
          }
          EOF
          )"
