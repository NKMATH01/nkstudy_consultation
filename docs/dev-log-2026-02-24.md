# 개발일지 - 2026년 2월 24일

## 작업 요약

설정 관리(선생님/반/학생) 기능 고도화 및 버그 수정 작업 진행.
과목별(수학/영어) 필터 추가, 학생 검색 기능, 학생 삭제 버그 수정 등.

---

## 신규 기능

### 1. 수학/영어 과목 필터 추가
- **선생님 관리**: 담임/클리닉 탭 옆에 `전체` / `수학` / `영어` 과목 필터 pills 추가, 과목별 인원수 표시
- **반 관리**: 반의 담당 선생님 과목 기준으로 `전체` / `수학` / `영어` 필터 추가
- **학생 관리**: 필터 영역에 `전체 과목` 드롭다운 추가 (배정반 → 담당 선생님 → 과목 체인으로 판별)
- 커밋: `689d67f`

### 2. 학생 이름 검색 기능
- 학생 관리 필터 영역 앞에 돋보기 아이콘 검색 input 추가
- 실시간 이름 필터링 (대소문자 무시)
- 기존 학년/반/상태/과목 필터와 조합 사용 가능
- 커밋: `9abfb5f`

---

## 버그 수정

### 3. 학생 삭제 안 되는 문제
- **원인**: `deleteStudent`가 일반 Supabase 클라이언트(`createClient`)를 사용하여 서버 액션에서 RLS 인증 컨텍스트 누락
- **수정**: `createAdminClient()` (service role key)로 변경하여 RLS 우회. 권한 체크(김기영만 삭제)는 코드 레벨에서 유지
- 커밋: `e5a93e5`

### 4. 학생 삭제 시 FK 제약 오류
- **증상**: `update or delete on table "students" violates foreign key constraint "withdrawals_student_id_fkey"`
- **원인**: `withdrawals` 테이블의 `student_id`가 학생을 참조하여 삭제 차단
- **수정**: 학생 삭제 전 `withdrawals.student_id`를 NULL로 해제 후 삭제. 퇴원 기록은 보존
- 커밋: `b69a93c`

### 5. 반 목록 학생 팝업 잘림 현상
- **증상**: 아래쪽 반의 학생 목록 팝업이 카드 영역 밖으로 나가면 잘림
- **원인**: 카드 컨테이너의 `overflow-hidden`이 absolute 팝업을 클리핑
- **수정**: `overflow-hidden` 제거, 헤더에 `rounded-t-2xl` 직접 적용하여 모서리 유지
- 커밋: `ceb1518`

---

## 이전 세션 작업 (2/23)

### 6. 고3 특수과목 반 필터 수정
- 기하/미적/확통 반이 고3 학년 필터에 표시되도록 수정
- 커밋: `0d4a3f8`

### 7. 학생 삭제 권한 제한
- 김기영만 학생 삭제 가능 (UI 숨김 + 서버 검증)
- 커밋: `5decac0`

### 8. 등록 안내문 개선
- 3개월 적응 로드맵 제거
- 체크리스트를 체크박스 UI로 변경 (10개 기본 항목, 추가/삭제 가능)
- 사용자가 체크한 항목만 안내문에 포함
- 과목별(수학/영어/영수) 맞춤 AI 프롬프트 적용
- 커밋: `e8d395d`, `3b0114e`

### 9. Claude API 529 에러 대응
- 529 과부하 오류 시 재시도 대기 시간을 5s/10s/15s로 증가
- 커밋: `7c38a3b`

---

## 수정 파일 목록

| 파일 | 변경 내용 |
|------|-----------|
| `src/components/settings/teacher-list-client.tsx` | 수학/영어 과목 필터 pills 추가 |
| `src/components/settings/class-list-client.tsx` | 과목 필터 + overflow-hidden 제거 |
| `src/components/settings/student-list-client.tsx` | 과목 필터 + 이름 검색 input 추가 |
| `src/lib/actions/settings.ts` | deleteStudent: admin 클라이언트 + FK 참조 해제 |

---

## 기술 노트

- **과목 판별 체인**: 학생 → 배정반(assigned_class) → 반 담당 선생님(teacher) → 선생님 과목(subject)
- **RLS 주의사항**: 서버 액션에서 일반 클라이언트(`createClient`)는 쿠키 인증이 불안정할 수 있음. 관리 작업은 `createAdminClient()`(service role) 사용 권장
- **FK 순서**: 자식 테이블 참조 해제 → 부모 테이블 삭제 순서 필수
